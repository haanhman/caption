{"2":{"dur":1,"text":"Hello, everyone!"},"3":{"dur":4,"text":"My name is Artem Boytsov and I'm a Software Engineer at Factual Inc."},"7":{"dur":4,"text":"Today I'm going to introduce an\nopen-source tool called Drake."},"12":{"dur":4,"text":"We're at Factual work with data quite a bit.\nWe are a data company."},"17":{"dur":4,"text":"We get data from different sources, \nwe clean it, we massage it, we join it"},"21":{"dur":1,"text":"with other data,"},"22":{"dur":3,"text":"we run machine learning\nalgorithms on it, some clustering algorithms, too,"},"26":{"dur":3,"text":"so as you can imagine, our data workflows"},"30":{"dur":2,"text":"tend to get quite complicated"},"32":{"dur":2,"text":"and they have a lot of steps."},"34":{"dur":4,"text":"Drake is our attempt to address some of\nthe issues that we ran into,"},"39":{"dur":4,"text":"and we hope other Data Scientists and \nData Engineers will find the tool"},"43":{"dur":2,"text":"as useful as we did."},"45":{"dur":3,"text":"So I have a window here with my\npresentation and a couple of terminal"},"49":{"dur":1,"text":"windows open."},"51":{"dur":2,"text":"I will give a short"},"53":{"dur":4,"text":"explanation about what Drake is and\nwhy we built it, and then I'll give a real-time"},"58":{"dur":2,"text":"demonstration of what it is like"},"60":{"dur":1,"text":"to work with Drake."},"62":{"dur":2,"text":"We'll go over some basic concepts"},"64":{"dur":2,"text":"as well as some advanced ones,"},"66":{"dur":1,"text":"and then I'll talk about"},"67":{"dur":3,"text":"what else is being in development."},"71":{"dur":3,"text":"So, let me maximize this window for the time being"},"74":{"dur":3,"text":"and give you some background info."},"78":{"dur":2,"text":"Drake is a data workflow management tool,"},"81":{"dur":2,"text":"but what is a data workflow?"},"83":{"dur":1,"text":"It can looks something like this:"},"85":{"dur":3,"text":"you download some data from some source;\nit's in the wrong format, so you"},"89":{"dur":2,"text":"convert it into JSON;"},"91":{"dur":1,"text":"there are some bad entries,"},"93":{"dur":3,"text":"you get rid of them; then you make some\nother changes to the data;"},"98":{"dur":2,"text":"then you copy it to HDFS,"},"101":{"dur":5,"text":"and you notice that you haven't even started\ndoing anything yet, and you already have 5 steps."},"107":{"dur":1,"text":"So this could get annoying quite fast"},"111":{"dur":2,"text":"and can get out of hand,"},"113":{"dur":4,"text":"so we looked at this problem and other\nproblems and tried to identify what"},"117":{"dur":4,"text":"the most painful experiences were,"},"121":{"dur":3,"text":"and we've identified several."},"125":{"dur":5,"text":"Being able to reproduce commands that perform \nactions with data is quite important;"},"130":{"dur":4,"text":"the locations of the files tend to get\nvery fuzzy when several"},"135":{"dur":1,"text":"engineers work on the same project;"},"136":{"dur":3,"text":"new versions of the files are created"},"140":{"dur":2,"text":"and tossed around; emails and being sent:"},"142":{"dur":1,"text":"\"Hey, I've created this"},"144":{"dur":2,"text":"new file in this directory, you should pick it up...\""},"147":{"dur":5,"text":"So it can get very messy and a lot of errors \ncan get introduced along the way."},"152":{"dur":4,"text":"One alternative is to build a\nprocess-heavy environment where all"},"156":{"dur":4,"text":"changes are reflected in some documentation\non the wiki - where everything is stored,"},"161":{"dur":2,"text":"locations of the files..."},"163":{"dur":3,"text":"But we thought an automated tool\nwould be a much better approach."},"167":{"dur":1,"text":"And then finally,"},"169":{"dur":1,"text":"when you work with"},"170":{"dur":2,"text":"the data and you created your workflow,"},"172":{"dur":4,"text":"you oftentimes work on the code as\nwell and make changes to particular steps."},"177":{"dur":1,"text":"So once you did that,"},"178":{"dur":3,"text":"the step has to be rebuilt as well\nas everything that depends on it."},"182":{"dur":4,"text":"But what is exactly? Sometimes it's\nhard to figure out in a very complicated workflow."},"188":{"dur":1,"text":"In production"},"190":{"dur":1,"text":"a tool like that can also be very handy."},"191":{"dur":4,"text":"There are several issues that anybody who"},"198":{"dur":2,"text":"babysat a decently complicated workflow"},"203":{"dur":1,"text":"knows to be problematic."},"208":{"dur":4,"text":"We need to have retries and resume after failure, there's status and"},"212":{"dur":3,"text":"logs collection, email notifications,\nautomatic backups."},"216":{"dur":0,"text":"Lots of different features that"},"220":{"dur":2,"text":"any workflow in the company"},"223":{"dur":5,"text":"could benefit from if we all used one\nsingle tool that implements them all."},"228":{"dur":3,"text":"So, we figured we need something like \"make for data\"."},"232":{"dur":2,"text":"We looked at the existing solutions"},"234":{"dur":6,"text":"that mostly designed to build software binaries\nfrom source code, such as make, ant, rake"},"241":{"dur":0,"text":"and others, and we found that"},"243":{"dur":3,"text":"they lack some features, they lack something that we needed, \nand they don't give you as much control"},"248":{"dur":5,"text":"over the execution as we wanted. \nSo we decided to build our own"},"253":{"dur":2,"text":"based on pretty much the same idea."},"255":{"dur":3,"text":"The workflow is defined as a number of steps"},"259":{"dur":2,"text":"with inputs and outputs,"},"261":{"dur":4,"text":"which in turn creates a dependency\ngraph managed by this tool."},"266":{"dur":1,"text":"And that allows"},"268":{"dur":4,"text":"to organize the data project around one\nsingle file just like a software"},"272":{"dur":4,"text":"project on the source code level is\norganized around a make file or a project file,"},"279":{"dur":2,"text":"so that any engineer on the project"},"281":{"dur":1,"text":"could look up where the files are,"},"283":{"dur":1,"text":"reproduce any steps,"},"285":{"dur":3,"text":"or modify the workflow."},"288":{"dur":2,"text":"So we came up with Drake,"},"290":{"dur":2,"text":"and the main design considerations were"},"293":{"dur":2,"text":"that we wanted the tool to be"},"296":{"dur":5,"text":"as flexible as possible. This is a \ncommand-line tool that can run anything"},"301":{"dur":1,"text":"as a child process."},"303":{"dur":3,"text":"We wanted it to be smart enough \nto be able to predict"},"306":{"dur":1,"text":"what steps will be built,"},"308":{"dur":3,"text":"and we wanted to give the users precise\ncontrol over execution, because this"},"313":{"dur":2,"text":"was often the most frustrating part:"},"316":{"dur":3,"text":"to execute exactly the subset of the\nworkflow that you're working on"},"320":{"dur":3,"text":"or debugging. \nBut most importantly"},"323":{"dur":2,"text":"we wanted the tool to be"},"325":{"dur":2,"text":"very easy to use,\nwith the reason behind it"},"328":{"dur":1,"text":"is that if the tool is not as easy"},"333":{"dur":2,"text":"or even the same to use \nas it is to write a bash script,"},"338":{"dur":3,"text":"a shell script to run your commands,"},"341":{"dur":3,"text":"then this is what the users are going to do."},"344":{"dur":0,"text":"And when this shell script"},"348":{"dur":2,"text":"is grown to be complicated enough,"},"351":{"dur":2,"text":"so that it's hard to handle, it might"},"353":{"dur":3,"text":"have already been too late. \nSo we wanted the user to start"},"357":{"dur":5,"text":"using Drake from the very beginning."},"362":{"dur":7,"text":"Let me give you the little demonstration."},"370":{"dur":1,"text":"Imagine we have"},"372":{"dur":4,"text":"a couple of input files. \nLet's say we have a list of people"},"377":{"dur":1,"text":"with the last name first,"},"380":{"dur":2,"text":"first name second, and a phone number"},"382":{"dur":1,"text":"in a comma-separated file."},"384":{"dur":3,"text":"And we also have a list of skills those\npeople can have"},"388":{"dur":2,"text":"with the name of the person in a slightly\ndifferent format"},"391":{"dur":3,"text":"(first-name [space] last-name)"},"394":{"dur":3,"text":"and the skills that this person has."},"398":{"dur":3,"text":"This is, of course, a very simplistic example - \nin real life these could be huge datasets"},"403":{"dur":3,"text":"and the steps can be expensive map-reduces."},"409":{"dur":1,"text":"But it's good for demonstration purposes."},"413":{"dur":2,"text":"We notice that \"skills\" is kinda dirty, we'll need to clean it,"},"417":{"dur":2,"text":"so let's write a very simple"},"420":{"dur":5,"text":"data workflow that joins these two files\ntogether and creates one"},"425":{"dur":1,"text":"file with person, phone number, and the skill set."},"430":{"dur":1,"text":"First of all, we'll have to remove some"},"435":{"dur":2,"text":"bad entries from the \"skills\" file."},"437":{"dur":2,"text":"I'm opening a workflow file"},"440":{"dur":5,"text":"named \"workflow.d\" - this is the default\nworkflow filename that Drake will look for"},"445":{"dur":3,"text":"(and of course it can be change from the\ncommand line)."},"449":{"dur":2,"text":"So let me type the first step in."},"457":{"dur":1,"text":"\"skills.filtered\""},"460":{"dur":3,"text":"as an output, \"skills\" as an input,"},"463":{"dur":4,"text":"and the commands -  \nindented shell commands."},"470":{"dur":1,"text":"We filter out every record"},"472":{"dur":2,"text":"that contains substring \"BAD\","},"477":{"dur":1,"text":"from $INPUT to $OUTPUT."},"481":{"dur":1,"text":"So this is it -"},"482":{"dur":5,"text":"we just created the first step. So here we\nspecify one or more output files, specify"},"487":{"dur":1,"text":"one ore more input files,"},"489":{"dur":4,"text":"and what Drake does is put this\ninformation into environment variables:"},"494":{"dur":3,"text":"the number of inputs, $INPUT1, $INPUT2 ..."},"499":{"dur":3,"text":"and then it runs this command as a child process."},"502":{"dur":0,"text":"A very simple concept."},"504":{"dur":2,"text":"So now we run \"drake\"..."},"506":{"dur":2,"text":"It tells us what it's going to do,"},"508":{"dur":2,"text":"which can be suppressed"},"510":{"dur":3,"text":"with --auto command-line flag, it also tells\nus why it's going to do this, and in this"},"514":{"dur":2,"text":"case it's because the output,"},"516":{"dur":3,"text":"which is this file, is completely missing."},"520":{"dur":1,"text":"Let's run it."},"522":{"dur":1,"text":"Done that."},"523":{"dur":2,"text":"Let's make sure that we have what we want..."},"526":{"dur":1,"text":"Yes, so all the bad records"},"528":{"dur":2,"text":"were removed from this file."},"530":{"dur":2,"text":"Now I need to take care of \"people\","},"532":{"dur":2,"text":"and we'll have to do two things:"},"534":{"dur":3,"text":"we'll have to first convert the name into\nthe format that we desire,"},"538":{"dur":3,"text":"which is \"first-name [space] last-name\","},"541":{"dur":4,"text":"and then we'll have to sort it, because\nthis is required for \"join\"."},"545":{"dur":2,"text":"The \"skills\" file is already sorted,"},"548":{"dur":1,"text":"but the \"people\" file is not."},"550":{"dur":2,"text":"So this means that we'll need to create\ntwo additional steps."},"554":{"dur":1,"text":"Let me edit the workflow file,"},"560":{"dur":4,"text":"Let's first take care of the full name -"},"564":{"dur":2,"text":"I'm using \"awk\" for that -"},"574":{"dur":0,"text":"...sorry..."},"575":{"dur":4,"text":"So, let me print first name first,"},"582":{"dur":1,"text":"space, last name then,"},"585":{"dur":2,"text":"separator, and phone number."},"592":{"dur":2,"text":"$INPUT redirect to $OUTPUT."},"595":{"dur":3,"text":"This is the implementation of the first step."},"599":{"dur":4,"text":"The implementation of the second step is even simpler than that -"},"603":{"dur":5,"text":"we just sort it by name."},"608":{"dur":1,"text":"Let me save the workflow..."},"610":{"dur":2,"text":"and I run Drake again."},"613":{"dur":3,"text":"So now it offers me to run these two steps, \nthe first step doesn't need to be run"},"617":{"dur":2,"text":"because all the files are up-to-date."},"619":{"dur":2,"text":"So let me confirm that..."},"622":{"dur":1,"text":"Great!"},"623":{"dur":2,"text":"Now if I run Drake again,"},"625":{"dur":3,"text":"it says that there's nothing to do,\nbecause everything is up-to-date."},"629":{"dur":2,"text":"Let's take a look at \"people.sorted\"..."},"632":{"dur":2,"text":"Perfect! This is exactly what we wanted."},"635":{"dur":1,"text":"So now what we need"},"637":{"dur":5,"text":"is just merge them together,"},"642":{"dur":2,"text":"And this creates a step"},"645":{"dur":1,"text":"that has to input files -"},"649":{"dur":2,"text":"the filtered set of skills"},"651":{"dur":4,"text":"and the sorted set of people."},"655":{"dur":7,"text":"A simple join, specify the field separator,"},"663":{"dur":1,"text":"$INPUTS to $OUTPUT."},"665":{"dur":1,"text":"So this variable, $INPUTS, contains"},"668":{"dur":3,"text":"all the input files given"},"674":{"dur":1,"text":"in space-separated form."},"676":{"dur":3,"text":"Let me also print something just for\ndebugging purposes and also"},"680":{"dur":7,"text":"to demonstrate what environment variables Drake sets up."},"696":{"dur":1,"text":"Let me save the workflow,"},"699":{"dur":2,"text":"and then run Drake again."},"702":{"dur":2,"text":"It only offers to"},"704":{"dur":3,"text":"build one target because \neverything else is up-to-date."},"707":{"dur":2,"text":"Let me confirm that..."},"709":{"dur":2,"text":"Here's the debugging output, number of inputs - 2,"},"712":{"dur":5,"text":"and this is the variable that contains \nall inputs, not just the first one,"},"718":{"dur":4,"text":"and as you can see, Drake fully\nqualifies the filename with the absolute path."},"724":{"dur":3,"text":"Let's take a look at the output..."},"728":{"dur":3,"text":"Great! This is exactly what we wanted to.\nSo that's all our workflow,"},"731":{"dur":1,"text":"and we could have"},"733":{"dur":5,"text":"put it in a linear bash script, but now we\nhave so much more flexibility and this"},"738":{"dur":2,"text":"is what I'm going to show next."},"740":{"dur":1,"text":"I would like to show you also that"},"743":{"dur":3,"text":"Drake saves stderr and stdout"},"747":{"dur":3,"text":"of the child process into a special directory."},"750":{"dur":5,"text":"It creates a directory for each step,"},"756":{"dur":2,"text":"and this is the last step, for example,"},"758":{"dur":3,"text":"the name is based off the name of the\nabsolute output file."},"763":{"dur":7,"text":"So let's cd into that..."},"775":{"dur":4,"text":"If we \"cat\" this file..."},"780":{"dur":2,"text":"This is our debugging input"},"782":{"dur":4,"text":"and Drake also saves all the variables that were given"},"787":{"dur":3,"text":"to the child process"},"790":{"dur":4,"text":"just for debugging sake."},"794":{"dur":1,"text":"O'key,"},"796":{"dur":3,"text":"so what we did is created a very simple \nworkflow that looks something like this:"},"800":{"dur":7,"text":"\"skills.filtered\", there are two steps here and then the join."},"807":{"dur":6,"text":"What make Drake very useful is how\nmuch control over execution you have."},"814":{"dur":1,"text":"So right now there would be nothing to do."},"815":{"dur":0,"text":"If you invalidate some file -"},"816":{"dur":2,"text":"if you \"touch\" it"},"821":{"dur":3,"text":"and change its timestamp,"},"824":{"dur":1,"text":"as any make-like system"},"826":{"dur":0,"text":"it will calculate what else needs to be done."},"830":{"dur":1,"text":"And notice that"},"831":{"dur":3,"text":"it will do \"people.fullname\""},"837":{"dur":4,"text":"because the file is not as fresh as it\nshould be - it's out-of-date,"},"841":{"dur":3,"text":"but the other targets will be built"},"844":{"dur":2,"text":"because they are projected to be,"},"846":{"dur":1,"text":"Drake doesn't know yet"},"848":{"dur":1,"text":"that it will need to build these,"},"850":{"dur":2,"text":"but it thinks that it will."},"852":{"dur":2,"text":"If we do this..."},"854":{"dur":1,"text":"O'key, all of them are built,"},"855":{"dur":2,"text":"I run Drake again - there's nothing to do."},"858":{"dur":5,"text":"But also what I can do is force the rebuild of everything."},"864":{"dur":1,"text":"\"...\" is a target that matches"},"867":{"dur":4,"text":"all existing steps and \"+\" means"},"872":{"dur":3,"text":"forcibly rebuild the targets."},"875":{"dur":7,"text":"So you see that it shows that it will build\neverything in the \"forced\" mode."},"883":{"dur":4,"text":"You can also specify only one target\nto be rebuilt, let's say, we want to build"},"888":{"dur":1,"text":"this particular step."},"889":{"dur":1,"text":"So, in \"forced\" mode,"},"891":{"dur":1,"text":"I want to specify"},"893":{"dur":7,"text":"that only this target should be build,\nand for this I use the \"=\" symbol."},"900":{"dur":4,"text":"Only one target..."},"905":{"dur":1,"text":"You can also do exclusions,"},"908":{"dur":1,"text":"for example,"},"910":{"dur":2,"text":"I want to build everything"},"913":{"dur":2,"text":"except this one particular target,"},"915":{"dur":5,"text":"which is, let's say, \"people.fullname\"."},"921":{"dur":7,"text":"So you see that all the targets \nare listed except this one."},"930":{"dur":2,"text":"A very common scenario is when you"},"933":{"dur":4,"text":"change something in one of the steps, \nand as a result, you want rebuild"},"937":{"dur":1,"text":"this step and everything that depends on it."},"941":{"dur":3,"text":"So let's say that we changed something here,"},"945":{"dur":3,"text":"in this command - I won't really change it,\nbut let's say that we did."},"948":{"dur":4,"text":"This means that we need to rebuild\nthis particular step and everything"},"953":{"dur":2,"text":"that depends on it directly or indirectly."},"955":{"dur":1,"text":"So for that Drake has"},"958":{"dur":7,"text":"what we call a \"down-tree\" mode."},"969":{"dur":1,"text":"It's turned on by using the \"^\" symbol."},"975":{"dur":1,"text":"So this command were forcibly rebuild"},"977":{"dur":2,"text":"the target \"people.fullname\""},"980":{"dur":3,"text":"and everything that depends on it."},"984":{"dur":5,"text":"As you see, \"people.fullname\", \n\"people.sorted\", \"output\"."},"989":{"dur":4,"text":"And the reason we chose \"^\" symbol is \nbecause it reminded us of a little tree -"},"996":{"dur":2,"text":"so this tree"},"998":{"dur":3,"text":"with the target on top and\ntwo targets that depend on it"},"1001":{"dur":1,"text":"kinda looks the same,"},"1003":{"dur":4,"text":"this is why we use it."},"1007":{"dur":4,"text":"So, we built a very simple workflow and\nI demonstrated all the flexibility"},"1012":{"dur":6,"text":"of the fine-grained control over what\nexactly will be executed."},"1018":{"dur":3,"text":"Now you might say that this workflow is very simple"},"1021":{"dur":2,"text":"and you need a sophisticated tool"},"1024":{"dur":3,"text":"like Drake to be able to handle that."},"1027":{"dur":3,"text":"But this is an example of \na real-life workflow"},"1030":{"dur":3,"text":"on one of our data projects."},"1034":{"dur":2,"text":"It's a dependency graph created based on"},"1036":{"dur":2,"text":"a Drake workflow file using graphviz"},"1039":{"dur":3,"text":"by one of our software engineers, \nand as you can see, it's not easy"},"1043":{"dur":1,"text":"to manage it all. We have"},"1045":{"dur":3,"text":"targets that have multiple outputs,\ntargets that have multiple inputs,"},"1048":{"dur":2,"text":"and it's getting quite complicated."},"1050":{"dur":4,"text":"So managing it without a tool like Drake \ncan be a real nightmare,"},"1055":{"dur":2,"text":"unless, of course, \nall the steps here are trivial"},"1057":{"dur":1,"text":"and re-running the whole workflow"},"1061":{"dur":5,"text":"has no cost whatsoever."},"1067":{"dur":2,"text":"Returning to our workflow,"},"1069":{"dur":2,"text":"the standard syntax of \"drake\""},"1072":{"dur":4,"text":"is the list of target selection\nexpressions, which can be one or several,"},"1076":{"dur":5,"text":"and each target selection is the name of\nthe output file, let's say, \"people.sorted\""},"1081":{"dur":5,"text":"and, for example, \"skills.filtered\","},"1086":{"dur":3,"text":"and one or several modifiers. \nSo, for example, this modifier says that"},"1090":{"dur":1,"text":"\"I don't care about any dependencies,"},"1092":{"dur":4,"text":"just build this target and nothing else\","},"1096":{"dur":2,"text":"this would say \"I don't care about\ntimestamps as well,"},"1099":{"dur":7,"text":"please build it regardless of whether\nit's up-to-date or not\"."},"1106":{"dur":4,"text":"If I remove this, Drake would still say there's\nnothing to do because all the targets"},"1110":{"dur":2,"text":"are up-to-date."},"1113":{"dur":2,"text":"And not only several"},"1115":{"dur":3,"text":"targets can be specified, but you can use\nregular expressions as well,"},"1118":{"dur":1,"text":"for example, this would build everything"},"1123":{"dur":4,"text":"that contains the word \"people\", i.e. every step \nthat has at least one output that contains"},"1127":{"dur":1,"text":"the word \"people\","},"1128":{"dur":3,"text":"which would in our case \nmatch these two steps."},"1132":{"dur":5,"text":"And you can also use tags, \nand this is my next topic."},"1138":{"dur":1,"text":"So, imagine for a second \nthat you need to"},"1142":{"dur":4,"text":"run some statistics on some of the\noutputs in our workflow."},"1147":{"dur":2,"text":"Let's say, something very simple"},"1149":{"dur":4,"text":"like calculate the number of lines \nand output it to the console."},"1154":{"dur":4,"text":"In real life, of course, it \nwould get more complicated."},"1158":{"dur":3,"text":"But you need to define another step, it doesn't\nhave any outputs, because it doesn't create"},"1162":{"dur":3,"text":"any files, but it does have an input,\nwhich is our final result,"},"1169":{"dur":3,"text":"and let's just do something silly like"},"1172":{"dur":1,"text":"output the number of lines."},"1174":{"dur":3,"text":"O'key, so this is fine, but how do you\ninvoke such a step?"},"1178":{"dur":3,"text":"And the answer is to use a tag."},"1182":{"dur":3,"text":"Tags are special names prepended by \"%\" sign"},"1190":{"dur":4,"text":"and they can be used to invoke specific steps.\nLet's do the same thing for \"people.sorted\"."},"1204":{"dur":7,"text":"And we just modified our workflow and\ncreated two little branches like these."},"1216":{"dur":1,"text":"...this is just a typo..."},"1218":{"dur":7,"text":"...let me fix it..."},"1226":{"dur":3,"text":"So it prints the number of lines."},"1229":{"dur":7,"text":"Or we can specify both of them."},"1238":{"dur":1,"text":"So, this file is not up-to-date,"},"1239":{"dur":2,"text":"because we just tinkered with it,"},"1241":{"dur":7,"text":"so let's build it first"},"1248":{"dur":3,"text":"and I will demonstrate what I wanted to."},"1252":{"dur":0,"text":"So this would match two steps."},"1256":{"dur":4,"text":"Tags are first-class citizens in Drake, \nmeaning that"},"1261":{"dur":5,"text":"you can do anything that you do with\noutput filenames with tags and,"},"1266":{"dur":4,"text":"for example, you can use regular expressions."},"1270":{"dur":2,"text":"This would match"},"1272":{"dur":1,"text":"all the targets that have"},"1274":{"dur":2,"text":"a tag that contains the word \"stats\","},"1277":{"dur":2,"text":"or you can also do \"forced\" mode."},"1287":{"dur":4,"text":"Since I re-evaluate this target in\nthe \"forced\" mode, it means that"},"1291":{"dur":3,"text":"this target has to be built from scratch,\nand every that it depends on will be"},"1294":{"dur":1,"text":"rebuilt."},"1296":{"dur":2,"text":"It means all of these"},"1299":{"dur":4,"text":"targets will be rebuilt and then\n\"%stats.output\" will be rebuilt."},"1303":{"dur":6,"text":"Or you can also use \"down-tree\" mode or\nexclusions or anything like that."},"1309":{"dur":1,"text":"Also,"},"1311":{"dur":4,"text":"you can specify multiple tags, and \ndifferent steps can share the same tag."},"1317":{"dur":3,"text":"For example,"},"1320":{"dur":2,"text":"I could create a tag name \"%all_stats\""},"1323":{"dur":6,"text":"and give it to every step \nthat generates statistics,"},"1329":{"dur":1,"text":"and then I don't have to use\nregular expressions, I can just"},"1333":{"dur":4,"text":"refer to this tag directly."},"1338":{"dur":2,"text":"This can be very convenient, \nbecause you can give"},"1341":{"dur":5,"text":"specific tags to certain subsets of your\noverall workflow that can be easily invoked."},"1351":{"dur":5,"text":"Another cool thing about tags is that \nthey can depend upon each other,"},"1356":{"dur":4,"text":"which allows you to create dependencies\nnot through input and output files, but"},"1361":{"dur":2,"text":"through tags. For example,"},"1364":{"dur":2,"text":"tag %b depends on tag %a"},"1367":{"dur":3,"text":"(this step doesn't even have\nany input or output files),"},"1370":{"dur":5,"text":"tag %c depends on tag %b,\nand this is, let's say, step 2,"},"1376":{"dur":6,"text":"and then tag %d depends on tag %c,\nand this is, let's say, step 3."},"1382":{"dur":2,"text":"Now if run it in the \"forced\" mode,"},"1384":{"dur":4,"text":"if I run evaluation of \"%d\" in the \"forced\" mode,"},"1389":{"dur":2,"text":"it will also pull"},"1393":{"dur":3,"text":"the first step and the second step,\nthen the third step."},"1396":{"dur":4,"text":"One, two, three. Now the reason I have to\nrun it in \"forced\" mode is because there are no"},"1400":{"dur":4,"text":"input and output files, and there's no\nsuch thing as timestamp-based"},"1404":{"dur":4,"text":"dependency resolution, so it doesn't even\nknow what to do - by default"},"1408":{"dur":1,"text":"it would not run it at all."},"1410":{"dur":3,"text":"And, of course, you can do all sorts of\nstuff that we discussed before, for example,"},"1413":{"dur":3,"text":"you can exclude the middle step,"},"1420":{"dur":5,"text":"or you can run, let's say, only \na specific target,"},"1425":{"dur":3,"text":"like only the second step,"},"1431":{"dur":3,"text":"and you can use all the variety of\ntarget selection mechanisms that we"},"1435":{"dur":2,"text":"covered before."},"1438":{"dur":3,"text":"Now let's imagine that I want to do\na little experiment."},"1441":{"dur":3,"text":"Let me remove this..."},"1444":{"dur":4,"text":"and this,"},"1448":{"dur":6,"text":"and this. And the experiment is I want to\nmake some change"},"1455":{"dur":2,"text":"in \"people.fullname\", for example."},"1457":{"dur":2,"text":"I want to replace"},"1462":{"dur":4,"text":"dashes in the phone numbers with\nsomething else, like \"equals\" signs,"},"1467":{"dur":2,"text":"or something equally silly, but this is for\ndemonstration purposes only."},"1472":{"dur":4,"text":"So, I will change this command to\nreplace all the dashes with \"equals\" signs"},"1477":{"dur":1,"text":"in field #3, which is the phone number,"},"1480":{"dur":4,"text":"and I save the workflow. \nNow if I just re-run everything,"},"1484":{"dur":2,"text":"then I will overwrite the existing files."},"1487":{"dur":2,"text":"What if I want to have \nsome sort of an experimental result"},"1492":{"dur":2,"text":"and see if I like it."},"1494":{"dur":5,"text":"This is where data branching comes in. \nSo what I can do is"},"1499":{"dur":3,"text":"run my current command \nin a specific branch."},"1503":{"dur":4,"text":"And because I changed this step,\nwhat I'lll have to do"},"1508":{"dur":1,"text":"is to tell Drake to force-rebuild this step"},"1514":{"dur":4,"text":"in \"down-tree\" mode, meaning this step and\neverything that depends on it,"},"1519":{"dur":1,"text":"because the timestamps of the existing files"},"1522":{"dur":2,"text":"are still up-to-date."},"1525":{"dur":2,"text":"\"forced\" mode, \"down-tree\", \"people.fullname\"."},"1534":{"dur":2,"text":"Yes."},"1536":{"dur":5,"text":"And now because I specified a branch,\nevery file that is created as a result"},"1542":{"dur":3,"text":"of this command will be given"},"1546":{"dur":3,"text":"a suffix and it will be created in this branch."},"1549":{"dur":3,"text":"So, \"people.fullname#exp\" used\nthe original file, \"people\" as its input,"},"1556":{"dur":1,"text":"but then after that,\neverything below that"},"1559":{"dur":6,"text":"used the branch versions as their input, and\nas a result we created a kinda parallel subtree."},"1566":{"dur":2,"text":"And, finally, \"output\", which is a join,"},"1570":{"dur":2,"text":"used the branch version of \"people.sorted\","},"1573":{"dur":4,"text":"but the regular version of \"skills.filtered\",\nbecause it didn't change in this branch."},"1577":{"dur":2,"text":"So if we take a look at the output now,"},"1580":{"dur":2,"text":"we'lll see that this change that we made"},"1582":{"dur":1,"text":"propagated all the way over here."},"1586":{"dur":1,"text":"And now I may want to"},"1589":{"dur":5,"text":"abandon this branch completely, and then\nall I have to do is just delete"},"1594":{"dur":2,"text":"all the files with the suffix,"},"1596":{"dur":5,"text":"or I can merge the\nbranch back into the trunk"},"1601":{"dur":1,"text":"by using --branch-merge option."},"1607":{"dur":3,"text":"I give the name of the branch and then\nI give what they want to merge, and by"},"1611":{"dur":7,"text":"default that would apply to all files."},"1622":{"dur":5,"text":"...I apologize that's --merge-branch, \nnot --branch-merge..."},"1627":{"dur":3,"text":"And by default it would apply to all files,\nand Drake will warn us that"},"1631":{"dur":1,"text":"it will move this file to the trunk,"},"1633":{"dur":2,"text":"this file to the trunk, and \nthis file to the trunk."},"1636":{"dur":1,"text":"But I can also use target selection"},"1637":{"dur":4,"text":"to specify what exactly I want to move."},"1641":{"dur":5,"text":"Maybe just this guy."},"1647":{"dur":2,"text":"And then everything else."},"1649":{"dur":1,"text":"Everything - just two left."},"1655":{"dur":3,"text":"And now the output is the same version\nthat we created and if I just run \"drake\""},"1659":{"dur":4,"text":"it will tell that there's nothing to do, \nbecause all the files are up-to-date,"},"1663":{"dur":1,"text":"and every output has a fresher\ntimestamp than the input."},"1669":{"dur":4,"text":"Now we covered quite a lot, we covered \nmost of basic functionality: target selection"},"1673":{"dur":3,"text":"dependency resolution, branching, tags,"},"1677":{"dur":4,"text":"and I would like to go over some\nfeatures that are not as important"},"1681":{"dur":2,"text":"but still pretty cool."},"1684":{"dur":5,"text":"So first of all, Drake does support HDFS.\nWhat it means is that Drake"},"1689":{"dur":4,"text":"can look at HDFS files and\ncompare their timestamps to local files or"},"1693":{"dur":1,"text":"other HDFS files"},"1695":{"dur":2,"text":"and resolve dependencies this way."},"1698":{"dur":2,"text":"And it also supports partial files"},"1700":{"dur":3,"text":"that Hadoop generates, so when you \ngive Drake a directory,"},"1705":{"dur":3,"text":"a map-reduce output for example,\nthen it will look at all the partial files"},"1709":{"dur":3,"text":"and make sure that the youngest\nfile in the output directory"},"1714":{"dur":1,"text":"is still fresher that the oldest file\nin the input directory."},"1719":{"dur":1,"text":"The other way around, I'm sorry."},"1721":{"dur":3,"text":"Let me demonstrate this,\nlet's say that"},"1725":{"dur":3,"text":"\"output\" is not the final destination, we\nwant \"output\" to be copied"},"1729":{"dur":3,"text":"to HDFS where some further \nprocessing will take place."},"1732":{"dur":3,"text":"So what I want to do is create another step,"},"1736":{"dur":1,"text":"and this time my output"},"1738":{"dur":2,"text":"is on the HDFS filesystem."},"1740":{"dur":3,"text":"hdfs: is a filesystem prefix."},"1743":{"dur":1,"text":"As you might have guessed,"},"1744":{"dur":3,"text":"I didn't need to use a prefix before\nbecause the default prefix is"},"1748":{"dur":2,"text":"the local filesystem."},"1751":{"dur":2,"text":"And then I'll need to copy it \nusing \"hadoop\" binary."},"1754":{"dur":3,"text":"I copy $INPUT into $OUTPUT."},"1758":{"dur":2,"text":"Because \"hadoop\" doesn't really"},"1761":{"dur":3,"text":"have an overwrite option, \nI will also have to remove"},"1764":{"dur":2,"text":"the old output"},"1766":{"dur":3,"text":"and suppress any errors if I get them."},"1770":{"dur":1,"text":"So now I saved the workflow"},"1774":{"dur":1,"text":"and let me run it."},"1775":{"dur":4,"text":"Everything in this workflow was\nup-to-date except this new step,"},"1779":{"dur":1,"text":"which we just added."},"1781":{"dur":1,"text":"Confirm..."},"1783":{"dur":3,"text":"Now this file..."},"1786":{"dur":2,"text":"...sorry, I made a little mistake..."},"1789":{"dur":1,"text":"...this is wrong..."},"1790":{"dur":1,"text":"...this is right..."},"1792":{"dur":4,"text":"...this is the correct command for removing..."},"1796":{"dur":7,"text":"Let me run it again..."},"1804":{"dur":3,"text":"Copying to HDFS... done."},"1808":{"dur":3,"text":"Now if I run it again it will say that\neverything is up-to-date,"},"1811":{"dur":4,"text":"because the HDFS file is younger. \nSo let me \"touch\" one of the inputs that"},"1816":{"dur":1,"text":"we have, let's say, \"skills\"."},"1820":{"dur":3,"text":"It will result in generating new \"skills.filtered\","},"1823":{"dur":1,"text":"new \"output\","},"1825":{"dur":5,"text":"and of course, copying \"output\" to HDFS."},"1830":{"dur":2,"text":"Which is very nice because if"},"1832":{"dur":2,"text":"one of your steps is local"},"1835":{"dur":3,"text":"and another is on HDFS, then it \nwould be nice to have some tool"},"1840":{"dur":1,"text":"to handle exactly if the copy has\nto take place or not."},"1845":{"dur":1,"text":"So, the other thing"},"1846":{"dur":4,"text":"that I would like to mention is\nthat targets don't have to have"},"1851":{"dur":4,"text":"inputs or outputs, there could be\na target that doesn't have"},"1855":{"dur":2,"text":"any inputs, for example,"},"1857":{"dur":2,"text":"if you want to download something from the Web,"},"1860":{"dur":2,"text":"or from any other source for that reason,"},"1863":{"dur":3,"text":"then this target doesn't have any input."},"1866":{"dur":1,"text":"Let's say, \"wget\","},"1870":{"dur":1,"text":"save it into the output file,"},"1873":{"dur":1,"text":"\"www.google.com\","},"1875":{"dur":1,"text":"save it."},"1876":{"dur":6,"text":"So now if I run Drake and say that I want\nto build \"download\"..."},"1882":{"dur":3,"text":"the reason is \"missing output\" because\n\"download\" file does not exist yet..."},"1887":{"dur":2,"text":"I confirm it..."},"1890":{"dur":1,"text":"and in the file \"download\""},"1892":{"dur":5,"text":"we have the homepage of Google."},"1897":{"dur":2,"text":"Another useful feature of Drake that \nI'd like to touch upon is methods."},"1902":{"dur":5,"text":"Methods is a simple way you can re-use \nsome of the code in your workflow."},"1907":{"dur":4,"text":"For example, what if \"output\" is not the\nonly file that we need to copy to HDFS?"},"1913":{"dur":1,"text":"What we can do instead\nis create a method"},"1916":{"dur":3,"text":"that runs exactly these commands"},"1919":{"dur":2,"text":"and name it \"copy-to-hdfs()\"."},"1925":{"dur":4,"text":"Now this creates a method with the same\nimplementation that we used before."},"1930":{"dur":3,"text":"And now to invoke this method"},"1934":{"dur":2,"text":"all we need to do"},"1936":{"dur":2,"text":"is define a step without a body"},"1941":{"dur":1,"text":"and give it the option with the method name."},"1944":{"dur":3,"text":"We haven't used options before \nbecause we didn't have to,"},"1948":{"dur":2,"text":"but any step definition after"},"1950":{"dur":3,"text":"output file and input file can have an\noptional section in"},"1954":{"dur":3,"text":"in square brackets that has one or several"},"1960":{"dur":6,"text":"name-value pairs. And in this case \nwe use the \"method\" option"},"1967":{"dur":1,"text":"and invoke it this way."},"1970":{"dur":5,"text":"Now let's copy something else to HDFS,"},"1976":{"dur":7,"text":"let's say, \"people\"."},"1985":{"dur":7,"text":"...sorry, \"people.sorted\"..."},"2000":{"dur":2,"text":"Now if I run Drake,"},"2002":{"dur":2,"text":"\"output\" doesn't have to be copied,\nbecause it's still up-to-date from"},"2005":{"dur":2,"text":"earlier experiments,"},"2007":{"dur":3,"text":"but this one does."},"2010":{"dur":4,"text":"And now if I made some changes \nto this code, I want to"},"2015":{"dur":1,"text":"be able to easily"},"2017":{"dur":4,"text":"re-run all the steps that use this\nmethod as an implementation."},"2021":{"dur":1,"text":"And this is possible:"},"2023":{"dur":0,"text":"you say: re-run all the targets"},"2026":{"dur":3,"text":"and them only, without an dependencies,\nthat use method \"copy-to-hdfs()\"."},"2033":{"dur":6,"text":"We need to use quotes now because\nparenthesis are special symbols for \"bash\"."},"2040":{"dur":1,"text":"And you see that"},"2041":{"dur":1,"text":"the steps are listed,"},"2043":{"dur":1,"text":"the reason is given,"},"2044":{"dur":1,"text":"this is \"forced (via method)\","},"2050":{"dur":4,"text":"and, of course, we can also \nsuppress confirmation"},"2055":{"dur":6,"text":"by using --auto command-line switch."},"2061":{"dur":1,"text":"And then finally,"},"2063":{"dur":3,"text":"I would like to touch on the notion of protocols."},"2066":{"dur":1,"text":"So far,"},"2069":{"dur":3,"text":"we didn't have to use anything other than shell,"},"2072":{"dur":2,"text":"but shell is not the only way\nto execute commands."},"2078":{"dur":4,"text":"Drake supports several protocols,\nand a protocol is basically"},"2083":{"dur":5,"text":"an interpreter - a way to execute \ncommands. In the shell case,"},"2088":{"dur":3,"text":"it creates a temporary file and \nruns the current shell on it,"},"2092":{"dur":4,"text":"in Python case or Ruby case,\nit might run the Python interpreter."},"2097":{"dur":4,"text":"There could be other protocols such as a\nPig query, then it would run a Pig query."},"2101":{"dur":3,"text":"So it all depends on the \nimplementation of the protocol"},"2106":{"dur":4,"text":"and currently the implemented protocols are\n\"shell\", \"python\", \"ruby\""},"2111":{"dur":2,"text":"and some more complicated \nClojure-related ones."},"2114":{"dur":3,"text":"We also plan to implement a Cascalog protocol,"},"2117":{"dur":1,"text":"but generally\nyou can add pretty much anything."},"2121":{"dur":1,"text":"So let me show you some\nPython code, let's say."},"2126":{"dur":2,"text":"And we'll do some simple \nstatistics on the output,"},"2128":{"dur":3,"text":"just as we did with \"wc\"."},"2135":{"dur":3,"text":"Give it a tag name,"},"2139":{"dur":2,"text":"given it an input file,"},"2142":{"dur":6,"text":"\"Hello from Python!\","},"2148":{"dur":1,"text":"and let's print\nthe number of lines in the file."},"2163":{"dur":3,"text":"So, first of all we need to specify"},"2166":{"dur":6,"text":"that we want to use the \"python\" protocol.\nThere's a special option for that,"},"2172":{"dur":1,"text":"so we can do it this way,"},"2174":{"dur":3,"text":"but \"protocol\" is actually the default\noption name, so you don't even have"},"2178":{"dur":3,"text":"specify the option name here,\nso we can just leave it like this."},"2181":{"dur":1,"text":"It's a little bit more readable."},"2183":{"dur":1,"text":"Also notice that"},"2184":{"dur":3,"text":"the way that I refer to the variables\nis a little different."},"2187":{"dur":5,"text":"I can't just use the syntax we used for shell,\nbecause this is bash's syntax"},"2192":{"dur":3,"text":"to refer to environment variables."},"2196":{"dur":3,"text":"I can, of course, get to \nenvironment variables from Python"},"2199":{"dur":1,"text":"pretty easily,"},"2200":{"dur":5,"text":"but what this does is that this is a thing\nspecific to Drake and this is string substitution."},"2205":{"dur":2,"text":"Before giving these command lines to Python"},"2208":{"dur":1,"text":"Drake will substitute this string"},"2214":{"dur":1,"text":"with the actual name of the input file."},"2216":{"dur":3,"text":"This is why I have to quotes here,\nbecause Drake doesn't know what"},"2220":{"dur":2,"text":"the context of this is."},"2222":{"dur":2,"text":"And Drake will just substitute it \nfrom here to here."},"2225":{"dur":3,"text":"So let me save it."},"2228":{"dur":5,"text":"And specify it."},"2234":{"dur":3,"text":"\"Hello from Python!\"\n3"},"2237":{"dur":1,"text":"Great!"},"2239":{"dur":3,"text":"This is exactly how I wanted it to work."},"2242":{"dur":3,"text":"So we've covered quite a lot of stuff:\nwe've covered some basic features,"},"2246":{"dur":4,"text":"some advanced features, I gave you a\ndemonstration of how it works."},"2250":{"dur":2,"text":"Now let me go quickly over"},"2252":{"dur":4,"text":"some features that are still in\ndevelopment. They are specified"},"2256":{"dur":3,"text":"in the design doc that we released,"},"2260":{"dur":4,"text":"but they're still not ready yet.\nWe do invision Drake to have a nice"},"2264":{"dur":4,"text":"status console, so when you run a data\nworkflow, it would listen on some port,"},"2268":{"dur":5,"text":"show you the list of steps with links\nto their existing logs,"},"2273":{"dur":2,"text":"dependency graph of the current workflow,"},"2276":{"dur":3,"text":"color-coded with what's done and what's next..."},"2280":{"dur":4,"text":"Also, an important feature is management of\nhistoric versions of the data files,"},"2288":{"dur":3,"text":"because if you have a tool like that,\nthat is given the information about inputs"},"2292":{"dur":1,"text":"and outputs, then you could easily"},"2294":{"dur":2,"text":"implement some very powerful features"},"2296":{"dur":3,"text":"for example, you could specify that you want"},"2300":{"dur":4,"text":"it to to keep to the last six versions of the\noutput file, and then you can revert easily by"},"2304":{"dur":2,"text":"providing the moment in the past \nyou want to rever to."},"2306":{"dur":4,"text":"Or you can specify"},"2311":{"dur":3,"text":"that you want to keep all the\nold versions for the last three months,"},"2315":{"dur":2,"text":"or maybe even until the backups"},"2318":{"dur":3,"text":"exceed one hundred megabytes."},"2322":{"dur":3,"text":"So this could be a very convenient\nautomated backup and revert mechanism."},"2326":{"dur":1,"text":"We also want to"},"2328":{"dur":4,"text":"implement retries, email notifications,\nand other small things. One particular thing"},"2333":{"dur":3,"text":"that you can do once you specify \nyour workflow in this way is"},"2337":{"dur":4,"text":"parallelize processes because Drake knows\nthat in this particular example"},"2342":{"dur":2,"text":"Process 1 and Process 2 are independent,"},"2344":{"dur":2,"text":"so you can run them the same time."},"2347":{"dur":4,"text":"If these are remote processes or\nmap-reduces on a Hadoop cluster"},"2352":{"dur":2,"text":"or two different clusters,"},"2354":{"dur":2,"text":"this is what you would want to do anyway."},"2356":{"dur":4,"text":"And also maybe one of those processes is"},"2360":{"dur":4,"text":"I\/O heavy and another is CPU heavy,\nor you have a multicore machine"},"2366":{"dur":5,"text":"and single-threaded processes \nor something like that."},"2371":{"dur":1,"text":"But anyway, Drake can"},"2374":{"dur":4,"text":"know in what cases it be\nparallelized and launch them at the same time."},"2379":{"dur":2,"text":"So, of course, this is an open source project,\nwe do want to implement all these features,"},"2383":{"dur":4,"text":"but your contribution is also welcome. If you\nfind this tool to be useful, we would be"},"2387":{"dur":1,"text":"really happy to work with you,"},"2389":{"dur":6,"text":"and to review the code and to hear from you."},"2396":{"dur":1,"text":"So one last thing"},"2397":{"dur":5,"text":"that came up several times is\nwhy we implemented this as"},"2402":{"dur":2,"text":"a command-line tool vs. a library."},"2405":{"dur":4,"text":"A library obviously is very flexible,\nbecause you can run native code"},"2410":{"dur":1,"text":"instead of being limited\nby running binaries and shell commands."},"2416":{"dur":2,"text":"So, our approach to that is"},"2418":{"dur":1,"text":"everything that you see here,\nthis syntax"},"2423":{"dur":3,"text":"is just one of the possible frontends to Drake."},"2427":{"dur":3,"text":"Other frontends can be implemented, \nfor example,"},"2431":{"dur":2,"text":"one can re-use the core Drake library"},"2433":{"dur":2,"text":"and write a Clojure Domain Specific Language,"},"2435":{"dur":2,"text":"that could look\nsomething like this:"},"2438":{"dur":3,"text":"specify the steps in a similar\nway and give them"},"2442":{"dur":4,"text":"Clojure function which would be run,\ninstead of running"},"2446":{"dur":2,"text":"shell commands and child processes."},"2449":{"dur":2,"text":"And then you can run it like this,"},"2451":{"dur":4,"text":"having re-used the target selection\nmechanism that we talked about previously."},"2460":{"dur":1,"text":"So, we don't think that"},"2461":{"dur":4,"text":"it's either\/or, and we're looking forward to"},"2465":{"dur":2,"text":"people creating more libraries"},"2468":{"dur":2,"text":"in their favorite programming language."},"2472":{"dur":4,"text":"Everything that runs under JVM, \nI suppose, would be compatible"},"2478":{"dur":2,"text":"with Drake's core library."},"2481":{"dur":3,"text":"So, that's it. Thank you very much for\nlisting and we hope that"},"2484":{"dur":4,"text":"you will find it useful. Please do not\nhesitate to contact us with feedback,"},"2488":{"dur":3,"text":"bug reports, code contributions or questions."},"2491":{"dur":1,"text":"We're looking forward to"},"2493":{"dur":3,"text":"seeing this tool being used \nin other places than Factual,"},"2497":{"dur":2,"text":"and we hope that"},"2499":{"dur":2,"text":"you'll find of some value, as we did.\nThank you. Bye-bye."}}