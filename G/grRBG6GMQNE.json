{"0":{"dur":1,"text":"PAUL LEWIS: I don't\nknow if you've ever"},"2":{"dur":4,"text":"done coding where you do an\nawful lot of architecture"},"6":{"dur":3,"text":"and wrangling, and then\npeople kind of looking over"},"9":{"dur":2,"text":"your shoulder go, so, you know,\nwhat have you been working on?"},"12":{"dur":5,"text":"You're like, well, lots, but\nthere's nothing really to see."},"17":{"dur":2,"text":"It's just a lot of\nmachinery under the hood."},"20":{"dur":2,"text":"So has it been for\nme, with the story"},"22":{"dur":2,"text":"of offline in this\nparticular app."},"25":{"dur":5,"text":"The media app has\ntwo offline cases."},"30":{"dur":4,"text":"One is relatively\nstandard, I suppose."},"35":{"dur":2,"text":"That you go to a\nvideo and you say,"},"37":{"dur":1,"text":"I'd like to watch\nthis one later."},"39":{"dur":0,"text":"Boop."},"40":{"dur":4,"text":"And we have to go and download\nnot only the video, but things"},"45":{"dur":5,"text":"like it's poster frame for the\nvideo element, it's album art,"},"50":{"dur":4,"text":"so we can do the media session\nAPI, it's dash manifest,"},"55":{"dur":1,"text":"And you kind of go, yeah."},"56":{"dur":1,"text":"I'll just get a\nbundle of things,"},"58":{"dur":3,"text":"and I'm going to go and get\nthose, and download them."},"61":{"dur":2,"text":"And one of the things that\nin this area that's still"},"64":{"dur":3,"text":"to land on the platform, for\nwhich Jake has-- and explained"},"67":{"dur":2,"text":"at least, is the\nbackground fetch API."},"70":{"dur":2,"text":"Wouldn't it be great,\ngiven that list of files"},"72":{"dur":2,"text":"that you want to get, to be\nable to hand off to the browser"},"75":{"dur":0,"text":"and say, hey."},"76":{"dur":3,"text":"Look, these 10 files, would you\nmind going off and getting them"},"79":{"dur":3,"text":"And just fire an event\nwhen that's completed so"},"82":{"dur":1,"text":"that I can decide what to do."},"84":{"dur":2,"text":"I can put them in a cache,\nor I can do whatever"},"86":{"dur":1,"text":"I feel like doing with them."},"88":{"dur":1,"text":"Well, that's\ncertainly on the way,"},"89":{"dur":1,"text":"and it doesn't exist right now."},"91":{"dur":2,"text":"So what I'm doing\nis, when you click on"},"93":{"dur":2,"text":"the I want to take this\nvideo offline, I do--"},"96":{"dur":2,"text":"in the page, I do a fetch and\nI populate the cache myself."},"99":{"dur":2,"text":"Now, that is quite a lot of\ncode in and of itself because--"},"102":{"dur":0,"text":"I'll show you why."},"105":{"dur":1,"text":"Let me tell you about\nthe second use case."},"107":{"dur":1,"text":"That's worth thing."},"109":{"dur":1,"text":"The second use case is this."},"110":{"dur":4,"text":"Imagine that you have\nwatched episode one of a show"},"115":{"dur":4,"text":"that you're interested in,\nand episode two is probably"},"119":{"dur":1,"text":"going to be of interest to you."},"120":{"dur":1,"text":"Maybe you subscribe to\nthe show or something."},"122":{"dur":1,"text":"And what we want\nto do is while I'm"},"123":{"dur":2,"text":"getting the entirety of episode\ntwo, you don't asked for that,"},"126":{"dur":1,"text":"and that's quite a lot of space."},"128":{"dur":1,"text":"But what we could\ndo is maybe just"},"129":{"dur":3,"text":"get the first one minute,\nor two minutes of the show"},"133":{"dur":2,"text":"because that kind\nof prefetching idea"},"135":{"dur":2,"text":"is good because it means\nthat, when you hit play, hey,"},"138":{"dur":1,"text":"we can just give\nyou a flying start."},"139":{"dur":4,"text":"And we can drop back to the\nadaptive network side later on."},"144":{"dur":2,"text":"And so I've been trying\nto tackle both of those."},"146":{"dur":1,"text":"In this particular\nvideo, I think"},"148":{"dur":2,"text":"what I want to do, is I just\nwant to talk about the service"},"150":{"dur":5,"text":"worker, and the case of\ngetting all the video."},"156":{"dur":2,"text":"The one where you say, I want\nto take this video offline"},"158":{"dur":2,"text":"Let's talk about\napproaching that problem."},"161":{"dur":2,"text":"Now, I'm not going to dive\ninto every little bit of code."},"163":{"dur":2,"text":"There are bits and\npieces in there"},"166":{"dur":2,"text":"that are quite-- they\ntake a while to explain."},"168":{"dur":1,"text":"And I think it's\nprobably the case,"},"170":{"dur":0,"text":"if you just look\nthrough the code,"},"171":{"dur":1,"text":"it'd probably make more sense."},"172":{"dur":3,"text":"But of course, if you do\nthat and you have questions,"},"175":{"dur":3,"text":"we have the comments below\nfor you to ask your questions."},"179":{"dur":2,"text":"So please do feel\nfree, as always,"},"181":{"dur":1,"text":"to go ahead and do that."},"182":{"dur":1,"text":"Enough talking."},"183":{"dur":2,"text":"Let's look at some codes."},"186":{"dur":0,"text":"Right."},"187":{"dur":5,"text":"I am in the point in my app\nJS where, thanks to the UI--"},"192":{"dur":1,"text":"in fact, let me show you the UI."},"194":{"dur":1,"text":"I should have\nstarted there really."},"195":{"dur":1,"text":"Imagine you are-- let's see."},"197":{"dur":2,"text":"Got this video of me and Jake\nhere, and you click this--"},"199":{"dur":1,"text":"we don't need this."},"200":{"dur":2,"text":"Getting rid of that."},"202":{"dur":1,"text":"I'm just going to close that."},"204":{"dur":3,"text":"Yeah, close it, and you'd click\nthe make available offline"},"207":{"dur":1,"text":"button."},"209":{"dur":4,"text":"And we start see-- that was\nvery quick, that was very quick."},"213":{"dur":4,"text":"I wish the internet was always\nthat fast for me, but it isn't."},"217":{"dur":2,"text":"And because it isn't, we\nhave the offline case."},"220":{"dur":2,"text":"Ha ha, perfect."},"222":{"dur":3,"text":"The bit where the\nspinning dial, you"},"226":{"dur":1,"text":"know, all that kind of stuff."},"227":{"dur":0,"text":"Right."},"228":{"dur":1,"text":"What's actually happening?"},"229":{"dur":2,"text":"So in the app, I\nfire an event that"},"231":{"dur":3,"text":"causes this on offline\ntoggle to be triggered."},"235":{"dur":2,"text":"And the interesting\nbit here is while I"},"237":{"dur":2,"text":"check whether we\nactually have the thing,"},"239":{"dur":3,"text":"and if we've already got it,\nthen do want to remove it,"},"243":{"dur":1,"text":"and so on."},"244":{"dur":0,"text":"And we'll delete it."},"245":{"dur":0,"text":"But if you haven't--"},"246":{"dur":2,"text":"which is that case that\nwe were just looking at--"},"248":{"dur":2,"text":"then we want to\nadd it to our cash."},"250":{"dur":3,"text":"And you can see I have\nthis offline cache class"},"254":{"dur":2,"text":"here when I try\nto add this thing."},"256":{"dur":2,"text":"So that's where the\nrubber hits the road."},"259":{"dur":2,"text":"So we should head\nover to that class."},"261":{"dur":1,"text":"Let me find the actual function."},"263":{"dur":1,"text":"Here we are."},"264":{"dur":1,"text":"And it takes in a\nbunch of things."},"266":{"dur":1,"text":"If we don't support\ncaching, then we just bail."},"268":{"dur":3,"text":"But we build a set of assets\nthat we're interested in."},"272":{"dur":2,"text":"Do you remember I said it was\nthings like the poster image,"},"275":{"dur":4,"text":"In fact, we have them here\nin the constants here."},"280":{"dur":2,"text":"When you go offline, when\nyou take a video offline,"},"282":{"dur":1,"text":"here's the things\nthat I currently get."},"284":{"dur":1,"text":"I get the artwork--"},"285":{"dur":2,"text":"I probably only need one of\nthese, actually, to be fair."},"287":{"dur":3,"text":"Anyway, I get both artworks,\na small poster image"},"291":{"dur":1,"text":"and the large poster image."},"293":{"dur":4,"text":"And I pretend-- so I get\nthe 720p offline manifest,"},"297":{"dur":1,"text":"which is a reduced\ndash manifest,"},"299":{"dur":3,"text":"with just the 720p\nvideo and the audio,"},"302":{"dur":3,"text":"instead of all of\nthe various options."},"305":{"dur":2,"text":"But I pretend that it's\ncalled dash manifests."},"307":{"dur":3,"text":"So when later on I ask Shaka\njust get DASH manifest."},"311":{"dur":1,"text":"If it hasn't got\nit stored offline,"},"313":{"dur":2,"text":"it gets the full one with\nall the representations."},"315":{"dur":0,"text":"If it [? has ?]\ngot installations,"},"316":{"dur":1,"text":"it's just going to\nget the 720p one."},"317":{"dur":3,"text":"That's my way of locking\nShaka into the Shaka player"},"321":{"dur":4,"text":"into only ever playing\nthe 720p video."},"325":{"dur":3,"text":"So it builds up the list of\nassets that we want to get."},"328":{"dur":3,"text":"And you'll see I have this\nspecial magical chunking thing"},"332":{"dur":0,"text":"here."},"333":{"dur":3,"text":"Hmm, right."},"336":{"dur":4,"text":"This has proved to be quite\nthe journey, because--"},"340":{"dur":3,"text":"I don't know if you didn't catch\nthe episode, the entry where"},"344":{"dur":6,"text":"I talked about\nthe idea that when"},"351":{"dur":3,"text":"we make a request for the video,\nwe do arrange requests, which"},"355":{"dur":3,"text":"means we don't ask for one gig\nof video up front, for example."},"358":{"dur":2,"text":"We say, I want these\nbites to these bites."},"361":{"dur":2,"text":"I want just this range, like\n1000 bytes, or 2000 bytes,"},"363":{"dur":1,"text":"or whatever."},"365":{"dur":1,"text":"And I said at the time\nwith my prototype,"},"367":{"dur":2,"text":"this is going to be a bit\nof an interesting one later."},"370":{"dur":2,"text":"Because in production, if\nyou've got a large video,"},"373":{"dur":2,"text":"you don't want to store\nit as one big file"},"375":{"dur":2,"text":"and then pull it out\nentirely into memory,"},"377":{"dur":2,"text":"is like a 1 gig array\nbuffer that you then slice,"},"380":{"dur":1,"text":"for example."},"381":{"dur":4,"text":"So what I do is as\nthe file's coming in,"},"385":{"dur":3,"text":"when I'm doing this part\nof this downloading of say"},"389":{"dur":2,"text":"the video files,\nand the audio files,"},"392":{"dur":1,"text":"I have this chunking file."},"393":{"dur":1,"text":"Which basically means,\non its way through,"},"395":{"dur":2,"text":"please split this\nup into chunks."},"397":{"dur":3,"text":"Later on in the service worker,\nwhich if we've got time,"},"401":{"dur":3,"text":"I'll show you, I ask for\nthe chunks that we need."},"404":{"dur":2,"text":"So for example, I have I think\nat the moment half megabyte"},"407":{"dur":1,"text":"chunks."},"408":{"dur":2,"text":"And so if you asked\nfor a particular range,"},"411":{"dur":3,"text":"it might be that I need\nchunks 9, 10, and 11."},"414":{"dur":2,"text":"And so I get 9, 10, and 11,\nand I create an array buffer"},"417":{"dur":2,"text":"from those three array\nbuffers, one big one."},"419":{"dur":2,"text":"And then I slice out from\nthat array buffer the bit"},"422":{"dur":1,"text":"that you actually asked for."},"424":{"dur":2,"text":"So it's my way of making\nsure that I don't pull out"},"426":{"dur":2,"text":"too much data into memory."},"428":{"dur":4,"text":"I chose in my chunk size, I\nchose half a meg at random,"},"432":{"dur":3,"text":"as a sort of guess that\nmaybe we'll need two,"},"436":{"dur":1,"text":"maybe three occasionally."},"437":{"dur":3,"text":"And sort of a meg, meg\nand a half in memory."},"441":{"dur":1,"text":"Yes, it's a bit garbage-y."},"442":{"dur":2,"text":"No, I don't like it."},"444":{"dur":2,"text":"But it does mean that I'm not\npulling out a one gig video"},"447":{"dur":2,"text":"into memory every time\nwe make a request."},"449":{"dur":1,"text":"I'm not saying\nit's always a gig,"},"450":{"dur":1,"text":"but I'm just saying\nthink big video,"},"452":{"dur":1,"text":"and that would be the problem."},"454":{"dur":1,"text":"Now, a longer term\nsolution for this"},"456":{"dur":1,"text":"that I'd love to\nsee on the platform,"},"458":{"dur":2,"text":"is the ability when\nyou say caches.match,"},"460":{"dur":1,"text":"and you give it\nthe URL, that you"},"462":{"dur":3,"text":"could give it some options\nbesides the cache name."},"465":{"dur":2,"text":"But you can actually give\nit the range as well,"},"468":{"dur":4,"text":"saying do you happen to also\nhave bites 1000 to 2000?"},"473":{"dur":3,"text":"Or you know, why\n[? assume? ?] It does,"},"476":{"dur":1,"text":"if it's got it in there."},"477":{"dur":2,"text":"But it should--\nthose kind of things,"},"479":{"dur":2,"text":"you should be able to give\nyou the answer, right?"},"481":{"dur":2,"text":"As in, no, I don't, because the\nfile is only 500 bytes long,"},"484":{"dur":1,"text":"or yeah, sure."},"486":{"dur":1,"text":"Well, a lot of that\nneeds specking."},"487":{"dur":1,"text":"It's not a thing\nthat exists today,"},"489":{"dur":1,"text":"so it's something I'm\nactually having to do,"},"490":{"dur":1,"text":"and it's a bit of a pain point."},"492":{"dur":0,"text":"But there we are."},"493":{"dur":2,"text":"So wow, just a\nchunk true, and that"},"495":{"dur":1,"text":"required a whole\nheap of explanation."},"497":{"dur":1,"text":"See what I mean?"},"498":{"dur":1,"text":"So what does the chunking do?"},"500":{"dur":2,"text":"Well, let's keep going\nthrough the code."},"503":{"dur":1,"text":"So we build on\nthis list of assets"},"504":{"dur":1,"text":"that we actually want to push."},"506":{"dur":4,"text":"And eventually, we get to\nthe idea of downloading."},"511":{"dur":3,"text":"And downloading is here."},"514":{"dur":2,"text":"This is probably one of\nthe more interesting bits,"},"516":{"dur":3,"text":"because what I do is I\nhave a thing with which I"},"519":{"dur":2,"text":"call track download--"},"521":{"dur":2,"text":"interesting."},"523":{"dur":3,"text":"And this actually looks\nprobably fairly straightforward,"},"526":{"dur":1,"text":"I imagine, to many of you."},"527":{"dur":1,"text":"Or if you haven't done\nservice work and stuff,"},"529":{"dur":1,"text":"this will look slightly bizarre."},"531":{"dur":3,"text":"If you have, it'll make sense."},"534":{"dur":4,"text":"We open the cache, and we\ntake whatever the request is"},"539":{"dur":2,"text":"and the response is, and we\njust pop that in the cache,"},"542":{"dur":1,"text":"if it's not set to chunk."},"543":{"dur":2,"text":"If it is, we cache in chunks."},"546":{"dur":2,"text":"So we seem to be doing two\nthings with all our responses."},"548":{"dur":1,"text":"All the things that\nwe've asked to download,"},"550":{"dur":1,"text":"we're doing two things with."},"552":{"dur":3,"text":"Firstly, we're tracking\nthem, and secondly, we're"},"555":{"dur":1,"text":"caching in chunks."},"557":{"dur":3,"text":"Now, I better not say the\nword streams three times"},"560":{"dur":3,"text":"in quick succession because\nif I do, Jake will show up."},"563":{"dur":2,"text":"And I think we can live\nwithout that, don't you?"},"566":{"dur":2,"text":"Shh, OK."},"568":{"dur":1,"text":"Streams, that's\nwhat we're doing."},"570":{"dur":2,"text":"Imagine that we've\nmade a fetch request,"},"572":{"dur":3,"text":"and one of the things we get\nback is a readable stream."},"576":{"dur":1,"text":"At least, you can\nin Chrome today."},"578":{"dur":1,"text":"You can also say\nwith the response,"},"579":{"dur":2,"text":"you say, give me the JSON,\nget me the text, get me"},"581":{"dur":0,"text":"an array buffer."},"582":{"dur":1,"text":"But you can say--"},"584":{"dur":2,"text":"I want to read this\nas a readable stream."},"586":{"dur":4,"text":"And in order to handle this,\nwhen a response is read,"},"591":{"dur":4,"text":"once it's consumed\nactually in this world,"},"595":{"dur":2,"text":"which means you can't do two\nthings with a single stream."},"598":{"dur":1,"text":"You can't both say\ntrack a download"},"599":{"dur":1,"text":"and count the\nnumber of bytes that"},"601":{"dur":3,"text":"are passed through the stream,\nas well as caching into chunks."},"604":{"dur":2,"text":"Like read the stream and\nchunk it up as it goes."},"607":{"dur":2,"text":"But you can clone a\nresponse, which is"},"609":{"dur":2,"text":"kind of like teeing a stream."},"611":{"dur":2,"text":"If you've not done\nanything with streams,"},"613":{"dur":2,"text":"the idea is that imagine\nthat the t-shape,"},"615":{"dur":2,"text":"and it comes up the middle,\nand then splits out into two."},"618":{"dur":2,"text":"It's our way of\ntaking the stream"},"620":{"dur":1,"text":"and turning it into\ntwo streams, which"},"622":{"dur":1,"text":"is exactly what I'm doing here."},"623":{"dur":1,"text":"So let's have a look\nat what we're doing."},"625":{"dur":6,"text":"So imagine then, we've got the\nvideo coming down the wire, OK."},"632":{"dur":1,"text":"We're going to do\ntwo things with it."},"633":{"dur":2,"text":"One, we're going to\ntrack the download."},"635":{"dur":3,"text":"Secondly, we're going\nto cache it into chunks."},"639":{"dur":2,"text":"So let's go down to\nthe track downloads."},"644":{"dur":1,"text":"Where is that?"},"645":{"dur":0,"text":"Where's track download?"},"646":{"dur":1,"text":"Maybe I should\njust look that up."},"650":{"dur":4,"text":"For each response, what\nI do is I get a reader."},"655":{"dur":1,"text":"You can see here,\nactually, I clone it."},"657":{"dur":1,"text":"So that's the first\nthing I actually do--"},"659":{"dur":3,"text":"I clone it to make sure\nthat whatever I do here"},"663":{"dur":1,"text":"on the response\nmeans that it's not"},"664":{"dur":2,"text":"going to be consuming\nthe response,"},"666":{"dur":1,"text":"and stop it being\nused somewhere else."},"668":{"dur":1,"text":"And the first\nthing I do, is when"},"669":{"dur":2,"text":"I get one of these responses\nI'll fetch the video,"},"672":{"dur":1,"text":"the fetch comes back and\nI go right, clone it."},"673":{"dur":1,"text":"First of all, clone this."},"675":{"dur":2,"text":"So that I can now\noperate independently"},"678":{"dur":2,"text":"with my clone of the response."},"681":{"dur":3,"text":"And then I ask for\na reader on there."},"685":{"dur":3,"text":"So clone.body.getreader,\nwhich is a readable stream."},"688":{"dur":1,"text":"And then I can\nstart reading, and I"},"690":{"dur":3,"text":"get-- there's a callback\nthat you pass to the promise"},"693":{"dur":0,"text":"when that happens."},"694":{"dur":3,"text":"So you read from the reader, and\nthen you say, on-stream data,"},"698":{"dur":1,"text":"do this thing."},"699":{"dur":2,"text":"And it's a bit\nconvoluted actually,"},"701":{"dur":3,"text":"when you do stuff with this\nbecause you kind of pull"},"705":{"dur":1,"text":"the callback, and\nthen in the callback,"},"707":{"dur":3,"text":"you setup the next\ncallback of the callback."},"710":{"dur":1,"text":"Yes, you do."},"712":{"dur":3,"text":"So on stream data, we just\nsay, well, are you done?"},"715":{"dur":2,"text":"If so, you know, if--"},"717":{"dur":0,"text":"blah, blah, blah."},"718":{"dur":3,"text":"We completed, is\nthe general idea."},"722":{"dur":2,"text":"Because one of the things\nthat's the case here,"},"725":{"dur":1,"text":"is that we've got a byte total."},"726":{"dur":2,"text":"So remember, I'm getting\nlike five or six files,"},"729":{"dur":1,"text":"and so the byte total\nhas to represent"},"730":{"dur":5,"text":"the entire total of all five,\nsix, however many files."},"736":{"dur":1,"text":"And so each one\nof these responses"},"738":{"dur":1,"text":"is contributing to that total."},"740":{"dur":3,"text":"And when one of the\nstreams finishes, it will--"},"743":{"dur":2,"text":"if the byte count isn't\nthe final byte amount,"},"746":{"dur":1,"text":"well, we don't need\nto do anything."},"747":{"dur":1,"text":"If it is the final\nbyte amount, we've"},"749":{"dur":2,"text":"actually completed the\ndownload of all our files."},"752":{"dur":2,"text":"And so we can basically\nsay, yeah, we're done."},"754":{"dur":1,"text":"We can call this callback,\nwhich is something"},"756":{"dur":1,"text":"I register somewhere else."},"757":{"dur":3,"text":"That's like, OK, update the UI,\nand all those kinds of things."},"760":{"dur":3,"text":"So remember now, we've had\nthe audio file come in,"},"764":{"dur":1,"text":"or the video file come in."},"765":{"dur":1,"text":"We've read some bytes."},"766":{"dur":3,"text":"And we basically keep\ntracking the length"},"769":{"dur":1,"text":"of each of these reads."},"771":{"dur":2,"text":"And that allows us to say, well,\nhow many bytes have actually"},"773":{"dur":1,"text":"come in?"},"774":{"dur":3,"text":"And we can post back to\nthis on progress callback"},"778":{"dur":2,"text":"with how many bytes we've\ngot, and how many bytes"},"780":{"dur":1,"text":"we're expecting in total."},"781":{"dur":1,"text":"And as I say, when\nwe finish, we can"},"783":{"dur":2,"text":"call this uncomplete that says\nright, all the bytes are in,"},"786":{"dur":1,"text":"we're done."},"787":{"dur":1,"text":"So that's what the\ntracking part does."},"788":{"dur":3,"text":"And that's a great\nway of using streams."},"792":{"dur":1,"text":"I say it's a great way--"},"793":{"dur":2,"text":"it's a garbage-y\nway, unfortunately."},"796":{"dur":3,"text":"Because imagine every time\nthis callback is called,"},"799":{"dur":3,"text":"this result here,\nit's an array buffer."},"802":{"dur":1,"text":"I believe it's got\nlots of bytes in it."},"804":{"dur":1,"text":"And I don't do anything\nwith those bytes,"},"805":{"dur":1,"text":"apart from ask for the length."},"807":{"dur":4,"text":"I would love it if we had some\nmechanism with, say a fetch,"},"812":{"dur":3,"text":"to say just give me progress\nevents like you do with XHR's."},"815":{"dur":1,"text":"That would be a nice thing."},"816":{"dur":2,"text":"And I believe it's something,\nonce again, that my friend"},"819":{"dur":2,"text":"Jake is looking at."},"822":{"dur":4,"text":"Hurry up, Jake, and whoever\nelse is working on it."},"826":{"dur":1,"text":"I have need of it."},"828":{"dur":1,"text":"I need it."},"829":{"dur":1,"text":"Anyway, so that's one part."},"831":{"dur":1,"text":"We're tracking the\ndownload, we basically"},"832":{"dur":1,"text":"ask for all the bytes that are\npassing through the stream,"},"834":{"dur":2,"text":"and we post back every\ntime we get an update,"},"836":{"dur":2,"text":"basically going,\nmore bytes came in."},"839":{"dur":2,"text":"And that's what I used\nto do, that pie chart."},"842":{"dur":1,"text":"If we've got time--"},"843":{"dur":1,"text":"probably won't--\nif we have time,"},"845":{"dur":2,"text":"I'll quickly show you how\nthat pie chart's done,"},"847":{"dur":1,"text":"it's pretty neat."},"848":{"dur":3,"text":"And then the other thing, as I\nsaid, was caching into chunks."},"852":{"dur":3,"text":"So this was the idea that\ninstead of a one gig video,"},"855":{"dur":3,"text":"or a half gig video, or a\n200 meg video in the cache,"},"858":{"dur":2,"text":"instead, what we want to do is\nwe actually want to separate it"},"861":{"dur":1,"text":"out into like half made chunks."},"862":{"dur":2,"text":"And then we can build our\nresponses in the service worker"},"865":{"dur":2,"text":"So the caching chunks,\nonce again with cloning"},"868":{"dur":2,"text":"the response, probably don't\ntechnically need to do that."},"870":{"dur":3,"text":"We could just consume the\nresponse here if we wanted to."},"874":{"dur":2,"text":"Not dissimilar-- get a reader."},"877":{"dur":5,"text":"And what we do is we go\nthrough reading in chunks."},"882":{"dur":3,"text":"And every time we\nhit our chunk size,"},"886":{"dur":4,"text":"we commit that particular\nchunk into the cache."},"890":{"dur":2,"text":"That's this commit buffer here."},"892":{"dur":2,"text":"And then we reduce the amount\nthat we're expecting still"},"895":{"dur":3,"text":"to come in by that chunk size,\nand we kind of restart again."},"898":{"dur":2,"text":"So we kind of have this\nbuffer, and we fill it up."},"901":{"dur":1,"text":"And then when that's\ndone, we basically"},"902":{"dur":2,"text":"pop that into a response."},"905":{"dur":1,"text":"Then we reset and go again."},"906":{"dur":2,"text":"And eventually, we\nrun out of bytes,"},"909":{"dur":2,"text":"which is the result.done."},"911":{"dur":2,"text":"And we commit whatever\nbuffer size we've"},"913":{"dur":1,"text":"got left there at the end."},"915":{"dur":2,"text":"So I imagine to say\ninstead of the half meg,"},"918":{"dur":1,"text":"we've ended with like\n200 bytes at the end."},"920":{"dur":3,"text":"We just commit to final buffer\nwith just those 200 bytes in."},"923":{"dur":1,"text":"The commit buffer has this."},"925":{"dur":4,"text":"It has one header that I set,\nwhich is just the chunk size."},"930":{"dur":2,"text":"Because I need to know later\non about how many chunks"},"933":{"dur":1,"text":"actually--"},"935":{"dur":3,"text":"or the chunk sizes that are\nactually stored, in case I've"},"938":{"dur":2,"text":"got a part chunk at the end,\nand I need to kind of know,"},"940":{"dur":1,"text":"do you actually\nhave enough bytes"},"942":{"dur":3,"text":"to satisfy this thing, the\nrange request that came in?"},"945":{"dur":4,"text":"Anyway, nonetheless, we do\na cache put of that chunk."},"950":{"dur":2,"text":"Actually, on the front\nend, let me show you"},"952":{"dur":1,"text":"what that looks like."},"953":{"dur":4,"text":"If we go to application, and\nwe take a look in the cache"},"958":{"dur":4,"text":"storage, you see the\nCDS show reel here,"},"962":{"dur":2,"text":"which is the cache for\nthis particular episode."},"964":{"dur":1,"text":"And there you go, look."},"966":{"dur":3,"text":"You can see it's split down\nthis 720p stream, all the way"},"969":{"dur":1,"text":"zero, one, two."},"970":{"dur":2,"text":"Don't you just love\nstream based ordering?"},"973":{"dur":2,"text":"All the way up to,\nwhat's that, 32?"},"975":{"dur":3,"text":"Yes, into 32 half\nmegabyte chunks."},"979":{"dur":1,"text":"Cool."},"981":{"dur":1,"text":"So that was the first bit."},"982":{"dur":1,"text":"And you can also see\nhere, by the way,"},"984":{"dur":1,"text":"there's the artwork\nand everything else."},"985":{"dur":3,"text":"And you see I actually keep one\ncache directly for this video."},"989":{"dur":2,"text":"That means that later\non, it's a lot easier"},"992":{"dur":1,"text":"from my UI perspective."},"993":{"dur":2,"text":"Because I can say, when\nI'm looking at this video,"},"996":{"dur":2,"text":"and I look at it's\nURL, I just go,"},"998":{"dur":4,"text":"do you have CDS\/showreel,\nby the way, caches?"},"1002":{"dur":2,"text":"And if the answer is\nsure, then I go cool."},"1005":{"dur":1,"text":"I'm going to assume\nyou have that video."},"1007":{"dur":2,"text":"And so my add and\nremove is based"},"1009":{"dur":1,"text":"at the kind of cache level."},"1010":{"dur":4,"text":"So when I say get rid of this,\nIf I remove this offline copy."},"1015":{"dur":1,"text":"Boop."},"1016":{"dur":2,"text":"And then I refresh the\ncache storage, refresh it."},"1019":{"dur":2,"text":"There you go, you see that\nthe entire cache is gone."},"1022":{"dur":2,"text":"But it didn't get in the\nway of say, the assets"},"1024":{"dur":5,"text":"that I need for all the\nicons and everything else."},"1030":{"dur":0,"text":"Cool?"},"1031":{"dur":0,"text":"Make sense?"},"1032":{"dur":1,"text":"Hopefully all that makes sense."},"1033":{"dur":2,"text":"Also, I have the old\nChrome devs with me"},"1036":{"dur":2,"text":"because I was running\nout on local host ATAT."},"1038":{"dur":3,"text":"Flashbacks of fun."},"1041":{"dur":2,"text":"Right."},"1044":{"dur":4,"text":"I'm going to stop\nthere, I think."},"1048":{"dur":1,"text":"In the next entry,\nI will actually"},"1049":{"dur":3,"text":"show you the\ncorresponding other side,"},"1053":{"dur":3,"text":"which will be the\nservice worker code."},"1056":{"dur":3,"text":"But before I do, I did say I\nwas going to show you the dial."},"1059":{"dur":1,"text":"Let me just show you\nthis here, right?"},"1061":{"dur":0,"text":"See this?"},"1062":{"dur":3,"text":"When it goes weeeooh, and it\ngoes round like that in a dial."},"1065":{"dur":0,"text":"How did I do that?"},"1066":{"dur":1,"text":"Before we go, I'm going\nto show you that really,"},"1067":{"dur":0,"text":"really quickly."},"1068":{"dur":4,"text":"It's in the--\n[HUMMING] where is it?"},"1072":{"dur":0,"text":"Where is it?"},"1073":{"dur":0,"text":"Where is it?"},"1074":{"dur":1,"text":"The download progress."},"1076":{"dur":1,"text":"Look at this."},"1077":{"dur":3,"text":"It is basically, this is\nwhat actually gets called"},"1080":{"dur":1,"text":"by the on progress callback."},"1082":{"dur":3,"text":"The percentage value is\na value between 0 and 1,"},"1085":{"dur":2,"text":"which is the bytes count\nover the bytes total."},"1087":{"dur":0,"text":"OK?"},"1088":{"dur":0,"text":"And it comes in."},"1089":{"dur":2,"text":"And we have a target,\nwhich happens to be an SVG."},"1091":{"dur":2,"text":"And that matters because\nwhat we're actually doing,"},"1094":{"dur":4,"text":"is doing an SVG path."},"1098":{"dur":2,"text":"It's a path, it's an SVG path."},"1100":{"dur":3,"text":"And you can see here, what we\ndo is we take that percentage,"},"1104":{"dur":4,"text":"and I do a little bit\nof cause and sign work"},"1108":{"dur":2,"text":"to figure out what\narc we actually need,"},"1111":{"dur":0,"text":"based on the percentage."},"1112":{"dur":4,"text":"So one is a full\nrevolution, and then it's"},"1116":{"dur":1,"text":"some proportion of\nthat revolution."},"1118":{"dur":3,"text":"So this is something I\ndidn't know before I actually"},"1122":{"dur":2,"text":"I had a sneaking suspicion\nthat with SVG you"},"1125":{"dur":3,"text":"could create paths on the fly."},"1129":{"dur":2,"text":"And I had a sneaking\nsuspicion that arcs might well"},"1131":{"dur":1,"text":"be one of those things."},"1132":{"dur":2,"text":"And you can see here that this\nis exactly what I'm doing."},"1135":{"dur":3,"text":"So I find the target,\nI find a thing"},"1138":{"dur":3,"text":"called path.dial, which is just\na path element inside the SVG."},"1142":{"dur":5,"text":"And I go through, and I create\nbased on a bit of calculation,"},"1147":{"dur":1,"text":"what I think the arc should be."},"1149":{"dur":3,"text":"And it's got weird flags,\nlike this large arc flag,"},"1153":{"dur":3,"text":"and targets, and all the--"},"1157":{"dur":3,"text":"have a look at the\ndocumentation on how"},"1160":{"dur":2,"text":"to do arcs inside of SVG."},"1162":{"dur":1,"text":"It is slightly bizarre."},"1164":{"dur":3,"text":"I'm much more used to the\ncanvas way of doing things."},"1167":{"dur":1,"text":"Oh, well."},"1168":{"dur":1,"text":"But this works brilliantly."},"1170":{"dur":5,"text":"So based on the percentage,\nI just spin an arc through,"},"1175":{"dur":3,"text":"and I just sort of make a\npie chart thing going up."},"1179":{"dur":1,"text":"And then, I set the\nattribute, and that"},"1180":{"dur":2,"text":"causes the SVG to update."},"1183":{"dur":2,"text":"And it all works\nreally well, actually"},"1185":{"dur":1,"text":"really, I'm very happy."},"1186":{"dur":5,"text":"So this little bit of code\nhere, all 50 odd lines of it"},"1192":{"dur":1,"text":"does the job just great."},"1194":{"dur":1,"text":"And obviously,\nmeans in my UI, it"},"1195":{"dur":4,"text":"can give a nice bit of progress\nto the user on how well"},"1199":{"dur":2,"text":"the download process is going."},"1202":{"dur":1,"text":"So there you have it."},"1204":{"dur":2,"text":"That is the purpose of\ndownloading the files,"},"1206":{"dur":3,"text":"chunking them, using streams,\ngiving progress, updating"},"1209":{"dur":1,"text":"the UI."},"1210":{"dur":2,"text":"We're not even done yet,\nbecause we actually haven't even"},"1213":{"dur":2,"text":"responded to the user's\nrequest, or the player's"},"1215":{"dur":2,"text":"request for range requests."},"1218":{"dur":1,"text":"Give it a sec, hang on."},"1219":{"dur":0,"text":"Let's try that again."},"1220":{"dur":3,"text":"We haven't even responded to\nthe video player's range request"},"1224":{"dur":2,"text":"coming through the\nservice worker."},"1226":{"dur":2,"text":"For that one, you'll have\nto join me next time."},"1228":{"dur":1,"text":"Now, don't forget\nyou can subscribe,"},"1230":{"dur":1,"text":"don't forget you can\ndrop in your comments."},"1231":{"dur":3,"text":"As always, thank you so much\nfor all the feedback, all"},"1235":{"dur":2,"text":"the ideas, all the\nsuggestions, all the comments"},"1237":{"dur":0,"text":"that you're making."},"1238":{"dur":3,"text":"I do love reading them\nall, and I will catch you--"},"1241":{"dur":1,"text":"yep, you guessed it--"},"1243":{"dur":2,"text":"next time."},"1245":{"dur":1,"text":"Hello, thanks for watching."},"1246":{"dur":1,"text":"If you enjoyed this\nvideo, well, you"},"1248":{"dur":2,"text":"may enjoy other videos\nthat we make too."},"1250":{"dur":1,"text":"So don't forget\nyou can subscribe"},"1252":{"dur":2,"text":"and you'll get notified when\nwe push out a new video."},"1254":{"dur":2,"text":"And there's more videos\nover there, or down there,"},"1257":{"dur":2,"text":"depending on how you're\nwatching the YouTubes right now."},"1259":{"dur":2,"text":"Definitely click on those."}}